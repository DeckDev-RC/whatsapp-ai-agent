version: '3.8'

services:
  backend:
    build: ./backend
    container_name: whatsapp-backend
    volumes:
      - ./auth_info_baileys:/app/auth_info_baileys
      - ./uploads:/app/uploads
    environment:
      - NODE_ENV=production
      - PORT=3000
    restart: unless-stopped
    networks:
      - SavyCoreNet
      - whatsapp-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whatsapp-backend.rule=Host(`savycore.com.br`) && PathPrefix(`/api`, `/socket.io`)"
      - "traefik.http.routers.whatsapp-backend.entrypoints=websecure"
      - "traefik.http.routers.whatsapp-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.whatsapp-backend.loadbalancer.server.port=3000"
      - "traefik.docker.network=SavyCoreNet"

  frontend:
    build: ./frontend
    container_name: whatsapp-frontend
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - SavyCoreNet
      - whatsapp-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whatsapp-frontend.rule=Host(`savycore.com.br`)"
      - "traefik.http.routers.whatsapp-frontend.entrypoints=websecure"
      - "traefik.http.routers.whatsapp-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.whatsapp-frontend.loadbalancer.server.port=80"
      - "traefik.docker.network=SavyCoreNet"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.whatsapp-frontend-http.rule=Host(`savycore.com.br`)"
      - "traefik.http.routers.whatsapp-frontend-http.entrypoints=web"
      - "traefik.http.routers.whatsapp-frontend-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

networks:
  SavyCoreNet:
    external: true
  whatsapp-internal:
    driver: bridge
