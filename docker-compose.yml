version: '3.8'

services:
  nginx:
    image: deckdev/whatsapp-gateway:latest
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.whatsapp-gateway.rule=Host(`savycore.com.br`)"
        - "traefik.http.routers.whatsapp-gateway.entrypoints=websecure"
        - "traefik.http.routers.whatsapp-gateway.tls.certresolver=letsencrypt"
        - "traefik.http.services.whatsapp-gateway.loadbalancer.server.port=80"
        - "traefik.docker.network=SavyCoreNet"
    networks:
      - SavyCoreNet
      - whatsapp-internal

  backend:
    image: deckdev/whatsapp-backend:latest
    volumes:
      - backend-auth:/app/auth_info_baileys
      - backend-uploads:/app/uploads
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - whatsapp-internal

  frontend:
    image: deckdev/whatsapp-frontend:latest
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - whatsapp-internal

networks:
  SavyCoreNet:
    external: true
  whatsapp-internal:
    driver: overlay

volumes:
  backend-auth:
  backend-uploads:
